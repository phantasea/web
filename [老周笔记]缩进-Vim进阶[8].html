<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
        <title>缩进-Vim进阶[8] - 老周笔记</title>
                <meta name="description" content="Vim进阶教程八，缩进">
                <link rel="icon" href="http://b.soont.com/themes/soon/favicon.ico" type="image/x-icon" />
        <link href="http://cdn.staticfile.org/twitter-bootstrap/3.0.2/css/bootstrap.min.css" rel="stylesheet">
        <link href="http://b-soont-com.u.qiniudn.com/themes/soon/css/style_bsoont.css" rel="stylesheet">
    <!--[if lt IE 9]>
      <script src="http://cdn.staticfile.org/html5shiv/3.7/html5shiv.min.js"></script>
      <script src="http://cdn.staticfile.org/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
        <script src="http://cdn.staticfile.org/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://cdn.staticfile.org/twitter-bootstrap/3.0.2/js/bootstrap.min.js"></script>
    </head>

    <body>
        <header role="banner" class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button data-target=".bs-navbar-collapse" data-toggle="collapse" type="button" class="navbar-toggle collapsed">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://b.soont.com">老周笔记</a>
            </div>
            <nav role="navigation" class="navbar-collapse bs-navbar-collapse collapse" style="height: 1px;">
            <ul class="nav navbar-nav">
                <li> <a href="http://b.soont.com/about">关于</a> </li>
                <li> <a href="http://b.soont.com/weibo">微博</a> </li>
                <li> <a href="http://b.soont.com/disqus">留言</a> </li>
                <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">链接<b class="caret"></b></a>
                        <ul class="dropdown-menu">
  <li class="dropdown-header" >特别感谢</li>
  <li><a href="http://www.vim.org">VIM</a></li>
  <li><a href="http://pico.dev7studios.com">Pico</a></li>
  <li class="divider"></li>
  <li class="dropdown-header" >网站编辑</li>
  <li><a href="https://stackedit.io">MD编辑器</a></li>
  <li class="divider"></li>
  <li class="dropdown-header" >友情链接</li>
  <li class="disabled"><a href="#">期待加入</a></li>
</ul>

                </li>
            </ul>
            <p class="navbar-text navbar-right">求知若饥 虚心若愚</p>
            </nav>
        </div>
        </header>
                
        <div class="container">
            <div class="row">

    <!--[if lt IE 9]>
                        <![endif]-->
                <div class="col-md-9">
                                            <article>
                        <div class="page-header">
                        <h2>缩进-Vim进阶[8]</h2>
                        <em><span class="glyphicon glyphicon-calendar"></span>2013/03/08</em>   <em><span class="glyphicon glyphicon-user"></span>hq零零e</em>  
                        </div>
                        <ul>
<li>前言</li>
<li>1 基础知识</li>
<li>2 预设规则

<ul>
<li>2.1 autoindent</li>
<li>2.2 smartindent,cindent</li>
<li>2.3 lisp</li>
</ul></li>
<li>3 进阶规则（indentexpr）

<ul>
<li>3.1 简单缩进</li>
<li>3.2 indentkeys</li>
</ul></li>
<li>4 缩进进阶

<ul>
<li>4.1 例2</li>
<li>4.2 例2</li>
</ul></li>
<li>5 进阶提示

<ul>
<li>5.1 去除缩进</li>
<li>5.2 缩进与格式化选项</li>
<li>5.3 缩进与折叠</li>
</ul></li>
<li>附录 A 表达式与沙箱</li>
</ul>

<h2>前言</h2>

<p>缩进可以使用文本结构更清晰易读。在Vi中，这通过是使用专用的外部程序（如：indent或c beautifier类的程序）实现的。Vim除保留了原有外部程序支持外更增加了一些内部的支持。包括了插入模式下的交互进行的缩进与'<code>=</code>'指令的缩进操作。</p>

<h2>1 基础知识</h2>

<pre><code>:h indent.txt
:h =
:h 'equalprg'
:h indentkeys
</code></pre>

<p>Vim中缩进有三种基本的使用方式。一是在普通（正常）模式下使用'<code>=</code>'指令。可以圈选范围后使用可以在指令后加上移动的指令。使用的方式与其他编辑指令是一样的（比如'd'）。'<code>==</code>'表示对当前行进行缩进。看下面的例子：</p>

<dl>
<dt><code>=ip</code></dt>
<dd>对当前段落缩进</dd>

<dt><code>=G</code></dt>
<dd>将由当前行至文章末尾的范围缩进</dd>

<dt><code>30==</code></dt>
<dd>缩进由当前行开始的30行</dd>
</dl>

<p>二是在编辑的过程（插入模式）使用某些键触发。比如，使用'<code>autoindent</code>'时，在插入模式中输入回车（即按回车键）时Vim自动对新行应用缩进规则。</p>

<p>三是粘贴文本时，使用'<code>]p</code>'指令对粘贴文本强制运用缩进。详见：<code>:h ]p</code></p>

<p>此外，'<code>gq</code>'或ex命令'<code>:left</code>'也能用来缩进文本。由于它们属于文本格式化的内容，这里不作讨论。</p>

<p>注意：当'equalprg'不为空时，'<code>=</code>'/'<code>gq</code>'总是使用equalprg中设置的外部工具。除此之外其他的缩进操作不影响。</p>

<p>在equalprg中使用的外部程序通常是整理（过滤）文本的工具，很少是单独用于缩进的工具。此外，如果通过外部程序实现缩进，有一些缺点不可避免：</p>

<ul>
<li>使用上不方便。如果要实现交互方式的缩进（即边输入边根据输入实现缩进），要不断运行外部程序，运行效率低。通过cinkeys/indentkeys的设置Vim可以在输入时计算缩进。</li>
<li>对大多数的一般应用而言，用户只需要最基本的缩进支持——如autoindent。而你却很难找到这样的程序。</li>
<li>许多工具不跨平台。</li>
<li>不够灵活。你其实不想为一些简单的缩进而写新的程序。</li>
</ul>

<p>Vim应用缩进的过程如下：</p>

<ol>
<li><p>依据设置使用缩进规则计算缩进宽度。</p>

<p>在不同的缩进规则同时开启时只能有一个起作用。在所有开启的缩进项中只有优先级最高的起作用。它们的优先级排列如下：</p>

<pre><code>indentexpr &gt; cindent &gt; smartindent &gt; ai
</code></pre>

<p>缩进宽度：以一个半角字符的宽度为基本单位计算的总缩进的量。缩进时，Vim会在行首增加相应宽度的空格或制表符。举例而言，如果缩进宽度为4，则Vim在行首增加4个半角空格；如果缩进宽度为8，Vim在行首增加一个制表符。</p></li>
<li><p>删除目标行首的制表符与空格。</p></li>
<li><p>根据expandtab与tabstop的设置及缩进宽度添加相应的空格或制表符。</p>

<p>制表符的宽度与'tabstop'的设置有关。默认值是8，所以8个半角空格（或其他字符）的宽度与一个制表符一样。如果将'tabstop'设为4，那么如果缩进宽度为9则Vim在行首增加2个制表符与1个半角空格。如果不想使用制表符可以<code>:se noet</code></p></li>
</ol>

<p>如果要实验各种缩进方式的话，建议定义如下的快捷键以便随时按<code>&lt;F9&gt;</code>查看缩进的设置：</p>

<pre><code>map &lt;F9&gt; :se autoindent? smartindent? cindent? lisp? indentexpr? equalprg? paste? cpoptions?&lt;CR&gt;
</code></pre>

<p>有些选项，如'paste'会影响缩进，所以需要查看这个设置项的情况。各个设置项的情况可以见各自的文档。</p>

<h2>2 预设规则</h2>

<p>为了方便用户Vim提供了一些预置的缩进规则：自动缩进（autoindent）、智能缩进（smartindent）、c缩进（cindent）、lisp缩进（lisp）。</p>

<h3>2.1 autoindent</h3>

<p>autoindent的缩进规则是最简单的。它使用与上一行一样的缩进量。换言之如果你为当前行加了3个空格的缩进，则开始下一行时Vim会自动添加3个空格的缩进。写python脚本时，使用这种缩进就够了。</p>

<p>使用autoindent，只要开启相应的选项：<code>:se autoindent</code> 或 <code>:se ai</code></p>

<p>注意：indentexpr、lisp、cindent、smartindent中的任一项开启都会覆盖autoindent的设置。</p>

<h3>2.2 smartindent,cindent</h3>

<pre><code>:h C-indenting
:h smartindent
:h cindent
:h cinkeys
:h cinwords
:h cinoptions
:h cinkeys-format
</code></pre>

<p>smartindent的缩进规则可应用于与c语法类似的语言如AWK、JavaScript等，当然也可以用在c语言。它的规则是将<code>{}</code>块内的语句缩进一定宽度。嵌套的<code>{}</code>块内的语句则相对于上一层语句缩进一定宽度。</p>

<p>cindent的缩进规则是专门用于c语言的缩进。与smartindent相比，cindent除了更严格地对应c语言的语法外，还增加了风格选项——为了适合不同的c语言风格，Vim提供了相当多的定置项改变cindent的缩进方式。设置项包括了：</p>

<dl>
<dt>cinkeys</dt>
<dd>这个选项定义了一组可以触发缩进的按键。在遇到这些按键是Vim会根据缩进规则重新计算当前行的缩进。定义按键的格式可以见:h cinkeys-format</dd>

<dt>cinwords</dt>
<dd>定义了一组让下一行相对对当前行增加缩进的关键字。在遇到定义在cinwords中的字时，Vim为接下来一行增加缩进。</dd>

<dt>cinoptions</dt>
<dd>缩进风格选项。参考：:h cinoptions-value、</dd>
</dl>

<h3>2.3 lisp</h3>

<pre><code>:h lisp
:h lispwords
</code></pre>

<p>根据lisp语法缩进，我懂得很少，所以——详见帮助。</p>

<h2>3 进阶规则（indentexpr）</h2>

<pre><code>:h cpo
:h indentexpr
:h indentkeys
</code></pre>

<p>与折叠一样，缩进也支持使用表达式定义缩进。这个表达式可以是任意表示数值的表达式也可以是返回数值的自定义/内置函数，这个数值将做为缩进的宽度。也与折叠一样Vim使用v:lnum表示目标行的行号。其它常用的函数包括了indent()、getline()、prevnonblank()、nextnonblank()等等。与折叠不一样的是使用缩进表达式不用另外指定缩进方式，只要赋于indentexpr项一个值，就会覆盖autoindent或smartindent/cindent的设置。</p>

<p>Vim的缩进表达式要比折叠表达式直观得多。我们直接通过例子了解缩进表达式的使用。</p>

<h3>3.1 简单缩进</h3>

<p>先看几个简单的缩进表达式：</p>

<pre><code>" 缩进宽度总为4
:se indentexpr=4
" 不使用表达式缩进
:se indentexpr=

" 将缩进宽度设为与&amp;sw设置一致
:se inde=&amp;shiftwidth

" 逐渐增加缩进
:se inde=v:lnum
</code></pre>

<p>这一组表达式还是比较容易理解的，都是直接将一某个数值（不需要什么计算）作为缩进量。 此外，三元条件表达式在折叠篇中也已经看了不少：</p>

<pre><code>" 偶数行缩进4格
:se indentexpr=v:lnum%2?0:4

" 取消注释行的缩进
:se inde=getline(v:lnum)=~'^\\s*#'?0:indent(v:lnum)

" 行首缩进：
:se inde=(getline(v:lnum-1)=~'^\\s*$')?4:0
" 悬挂缩进：
:se inde=(getline(v:lnum-1)=~'\\S')?4:0

" 相对于上一行缩进行首带着-号的行
:se inde=getline(v:lnum)=~'^\\s*-'?indent(v:lnum-1)+4:0
</code></pre>

<p>这一小节的的最后一个例子是个常用到的缩进：根据编号缩进。</p>

<pre><code>1. statement
1.1. substatement
2. statement
2.1. substatement
2.1.1. subsubstatement
2.2. substatement
</code></pre>

<p>在看需求文档时几乎每一行都是编号的。程序员从不同的渠道获得这些文档，可能是从某个需求管理系统，电子邮件或者SKYPE。它们有不一样的缩进，有一些甚至没缩进。自动缩进工具此时显得特别有用。</p>

<p>对于写需求文档的人来讲他们除了要能智能的缩进他们可能还需要一个可以自动编号（根据缩进或者行首的<code>*</code>字符的个数）的编辑器。当然Vim用户是不需要再花时间找这样的工具的！</p>

<p>要将这些编号可以用以下的脚本：</p>

<pre><code>" 根据编号缩进
:se inde=len(split(substitute(getline(v:lnum),'^[\ \\t]*\\([0-9.]\\+\\).*','\\1',''),'\\.'))*&amp;sw
</code></pre>

<p>将函数写成单行形式的最大挑战是要加上非常多的转义符。而且记住：使用单引号，不要用双引号。具体的原因See <a href="#">附录的解释</a>.</p>

<p>如果不想记转义规则可以用函数将它包装起来。当然，这样也就没办法在模式行中使用了：</p>

<pre><code>func! GetIndent(lnum)
  let ind=len(split(substitute(
       \ getline(a:lnum),'^[ \t]*\([0-9.]\+\).*','\1',''),'\.'))
  return ind
endfunc
se inde=GetIndent(v:lnum)*&amp;sw
</code></pre>

<h3>3.2 indentkeys</h3>

<p>在定义了缩进表达式后，我们可以在文本输入完成后使用'<code>=</code>'或'<code>==</code>'进行缩进。如果要在编辑的过程中实时地缩进，我们需要定义合适的'indentkeys'。考虑下面的表达式：</p>

<pre><code>" 将字串长小于20的句子右对齐
" 这条命令实际等价于:right 20
se inde=20-len(substitute(getline(v:lnum),'^[\\t\ ]\\+','',''))
</code></pre>

<p>因为默认的indentkeys中包含了o,O，所以在开启新行时，Vim就已经计算了缩进——但这时我们的输入还没完成，所以缩进宽度是错的。我们需要让Vim在句子输入完成后再计算缩进宽度。也就是在我们按下回车后先计算并应用缩进再插入换行符。同时还需要定义一个在插入模式中可以使用的缩进命令，以随时强制Vim计算缩进。就像所有Vim的其他功能一样，Vim也为这个功能提供了设置项，这次是indentkeys，</p>

<pre><code>se indentkeys=*&lt;CR&gt;,!^F
</code></pre>

<p><code>*&lt;CR&gt;</code>表示在插入模式下按回车键时，先重新计算缩进再加入换行符。如果只有<CR>则Vim会先加入换行符再计算缩进——这时新增行成了目标行。<br />
<code>!^F</code>表示在插入模式下按<code>Ctrl-F</code>时，重新计算缩进但不插入字符。关于<code>*</code>和<code>!</code>在indentkeys（及cinkeys）中的意义可以见：<code>:h indentkeys-format</code></p>

<h2>4 缩进进阶</h2>

<p>在处理缩进时经常会遇到嵌套的格式文本，幸好它们都大同小异。考虑下面的文本嵌套结构：</p>

<pre><code>[marker]
  block
  [marker]
    block
  [end marker]
[end marker]
</code></pre>

<p>这种类型的文件很常见xml（<xxx>block</xxx>），C代码（{block}），opera书签文件（opera6.adr）等<sup id="fnref:1"><a href="#fn:1" class="footnote-ref">1</a></sup>。</p>

<p>下面我们将一起为两个使用这种结构的文本的写缩进脚本。</p>

<h3>4.1 例2</h3>

<p>在一些情况下'marker'与'end marker'不那么明显。下面是一个文本目录树：</p>

<pre><code>+ item1
- item2
  + subitem
  - subitem
    * subsubitem
  -
-
* item3
</code></pre>

<p>这里的marker是跟减号跟随文字，end marker则是一个减号（后面没有文字）。事实上将这个end marker改成一个空行，在处理上也不会有什么不同。<sup id="fnref:2"><a href="#fn:2" class="footnote-ref">2</a></sup></p>

<p>但无论是哪种形式只是对marker的判别方式有一些区别，其结构并无本质区别。</p>

<p>状态及对应的处理方式;</p>

<ul>
<li>当前条目如果只有一个减号（<code>^\s*-\s*$</code>），则当前条目相对上一条目减少缩进量。</li>
<li>上一条加号或星号开始（<code>^\s*[+*]</code>） 当前条目与上一条目的缩进一样</li>
<li>上一条如果只有一个减号（<code>^\s*-\s*$</code>），则当前条目减少缩进量。</li>
<li>上一条如果由一个减号开始（<code>^\s*-\s*\S\+$</code>），则当前条目增加缩进量。</li>
</ul>

<p>这样脚本就很清楚了，</p>

<pre><code>func! MyIndent(lnum)
  let lastline=getline(a:lnum-1)
  if a:lnum==1 | return 0 | endif

  if getline(a:lnum)=~'^\s*-\s*$'
    let diff=-1
  elseif lastline=~'^\s*[*+]'
    let diff=0
  elseif lastline=~'^\s*-\s*$'
    let diff=-1
  elseif lastline=~'^\s*-\s*\S'
    let diff=1
  endif 

  return indent(a:lnum-1)+diff*&amp;sw
endfunc

se inde=MyIndent(v:lnum)
</code></pre>

<h3>4.2 例2</h3>

<p>最后是一个完整的例子仍是嵌套的文本块，看一下下面的文本，</p>

<pre><code>[
outer block
[[
inner block
]
]
[
[inner block]
]
]
</code></pre>

<p>这个仍然是marker与end marker的格式。<code>[</code>是marker，<code>]</code>是end marker。我们要写一个使之能正确缩进的脚本，其中的关键在于判断嵌套的深度来决定缩进宽度。我们可以使用一个buffer变量保存嵌套深度，遇到[增加，遇到]减少深度。但因为=命令可以多次不连续地对不同文本块使用，所有变量的存在可能会导致不正常的结果。为此，仍像前面的例子一样我们将根据前一行的状态判断缩进深度。根据上一行的marker，计算当前行的缩进宽度。描述如下，</p>

<ul>
<li>如果上一行是<code>[</code>，当前行增加宽度</li>
<li>如果上一行是<code>]</code>，当前行减少宽度</li>
<li>否则，保持上一行的宽度</li>
</ul>

<p>还要考虑到一点，同一行可能数量不等的多个<code>]</code>或<code>[</code>——事实上这是这个例子与上一个例子唯一的不同之处。因为一对<code>[]</code>的缩进刚好可以抵消，我们可以通过它们的差决定缩进的宽度。另外，如果当前行有<code>[</code>或<code>]</code>还要相应增加或减少当前行的缩进。所以改进后的描述如下，</p>

<ul>
<li>将上一行[的数量减去]的数量，得到初始的缩进宽度

<ul>
<li>结果为正，则为当前行增加相应数量的缩进</li>
<li>否则，为当前行减少相应数量的缩进</li>
</ul></li>
<li>在前面计算的基础上计算当前行的[与]的差，得到缩进的增量。

<ul>
<li>结果为正，则为当前行增加相应数量的缩进</li>
<li>否则，为当前行减少相应数量的缩进</li>
</ul></li>
</ul>

<p>现在我们可以写脚本了，</p>

<pre><code>" 其中，根据[]数量计算宽度这一段是重复的，
" 我们可以写成一个单独的函数

func! IndentSum(lnum,incre)
" 两个参数分别表示目标行行号与缩进的初始量
    let line=getline(a:lnum)
    " 通过'['与']'的数量计算缩进宽度
    " 每多一个[则增加一个单位的缩进
    " 每多一个]则减少一个单位的缩进
    " 没有]或[的行使用与上一行一样的缩进
    let in=len(split('x'.line.'x','['))-1
    let ou=len(split('x'.line.'x',']'))-1
    " [的数量减去]的数量
    return &amp;sw*(in-ou)+a:incre
endfunc

func! BIndent(lnum)
    " 上一非空行的行号
    let llnum=prevnonblank(a:lnum-1)
    if llnum==0 | return 0 | endif
    " 由上一行得到初始的缩进宽度
    let ind=IndentSum(llnum,indent(llnum))
    " 计算当前行的的缩进增量
    let ind=IndentSum(a:lnum,ind)
    return ind
endfunc

se inde=BIndent(v:lnum)
</code></pre>

<p>现在，你已经可以写c缩进的脚本了（将上面脚本中的<code>[]</code>换成<code>{}</code> :) ）。这种缩进的计算方式几乎是一个套路了。基于同样的模式，同样的工作流程的一个xml的缩进的例子可以见Vim安装目录中<code>indent/xml.vim</code>。</p>

<h2>5 进阶提示</h2>

<p>这一章是关于缩进的一些零散的内容。</p>

<h3>5.1 去除缩进</h3>

<pre><code>:h g@
:h operatorfunc
</code></pre>

<p>现在你可以用'<code>=</code>'进行缩进了你可能还需要一个可以去除缩进的指令。当然你可以用'<code>&lt;&lt;</code>'，但这个命令一次只缩进一层。很遗憾你并不能使用'<code>4&lt;&lt;</code>'将文本向左移4次（这条命令将4行文本往左移一次），你只能一次一次来（或者按1次<code>&lt;&lt;</code>，再按3次.）。如果你确实需要一次去除许多缩进的话，可以使用下面的map宏：</p>

<pre><code>:nnoremap &lt;&lt;&lt; :left&lt;CR&gt;
:vnoremap &lt;&lt;&lt; :left&lt;CR&gt;
</code></pre>

<p>这个宏有两个主要缺点，一是会使<code>&lt;&lt;</code>命令变慢，因为Vim要等等看后面是否还有一个&lt;。这可以通过减小设置项'timeoutlen'的值，减少等待时间，但你的操作也要相应变快才行。或者另外定义一个按键序列，不使用<code>&lt;&lt;&lt;</code>。二这条命令不支持对象选择。这不算是个很大的缺点，但如果支持的话显然会更方便一点。我们可以用<code>g@</code>包装上命令，使之具有对象选择的功能：</p>

<pre><code>func! Deindent(dummy)
  exe 'normal! ' . "'[V']:left\&lt;CR&gt;"
endfunc
se opfunc=Deindent

nnoremap &lt;&lt;&lt; g@
vnoremap &lt;&lt;&lt; g@
</code></pre>

<p>现在试一下<code>&lt;&lt;&lt;G</code>, <code>&lt;&lt;&lt;aB</code>或<code>&lt;&lt;&lt;ip</code>。<code>g@</code>的用法见Vim文档。</p>

<h3>5.2 缩进与格式化选项</h3>

<pre><code>:h gq
:h formatoptions
:h formatprg
</code></pre>

<p>缩进与文格式化(gq)紧密相关，你可能会有兴趣看一下这一部分的内容。</p>

<h3>5.3 缩进与折叠</h3>

<p>在折叠篇我们知道可以以缩进作为折叠的规则。因此这实际给我们一种同时定义缩进与折叠的方式。在学了这一篇之后这个折叠的缩进规则就能派上用场了！</p>

<pre><code>:se fdm=indent
</code></pre>

<h2>附录A 表达式与沙箱</h2>

<p>直接写表达式跟将表达式包装在一个函数中有一个最主要的不同是，前一种方式中的\及空格需要进行转义。所以在模式行中要使用很多的\。另外要注意的是"与'是不一样的。</p>

<pre><code>:h expr-quote
:h expr-'
</code></pre>

<p>在写Vim脚本或命令时"的字串是允许使用转义字符的，而'的字串则不进行转义。如"\t"表示的是一个制表符而'<code>\t</code>'表示的是一个斜杠和一个字母t。'<code>\t</code>'等价的双字号字串是"<code>\\t</code>"。</p>

<p>在脚本篇我们就讲过了一个例子：</p>

<pre><code>echo '|\t|'
echo "|\\t|'
</code></pre>

<p>但对于indentexpr及其它在沙箱中计算表达式的设置项来讲，数值表达式在进入沙箱中先进行了一次表达式的计算——只是计算字串值。例如，当你执行<code>:se inde=len('abc\\t')</code>时，先计算字串的“安全值”。即在计算函数的值之前，Vim会先计算字串表达式的值，所以函数现在成了：</p>

<pre><code>"len('abc\\t')"
</code></pre>

<p>这个字串表达式的值，大家都知道是（通过<code>:echo &amp;inde</code>可以观察字串表达式的值）：</p>

<pre><code>len('abc\t')
</code></pre>

<p>然后，再计算函数的值，结果是4（3个字母加一个制表符）。</p>

<p>在执行=命令时，Vim首先计算了字串表达式的值，再eval字串的值（即执行len('abc')并返回数值）。</p>

<p>注意，在写表达式时你并不需要在前后加上引号，Vim会自动为你加上双引号并进行计算字串的值。这个过程中Vim还进行了一些处理以确保值是“安全的”。其中包括移掉未转义的\。可以简单的记为这些表达式中不能有未转义的双引号"，空格和斜杠。还是例子比较实在，</p>

<table>
<thead>
<tr>
  <th>命令</th>
  <th>字串表达式</th>
  <th>字串值</th>
  <th></th>
</tr>
</thead>
<tbody>
<tr>
  <td>:se inde=len('&#92;t')</td>
  <td>"len('&#92;t')"</td>
  <td>len('\t')</td>
  <td></td>
</tr>
<tr>
  <td>:se inde=len('\t')</td>
  <td>"len('\t')"</td>
  <td>len('t')</td>
  <td>未转义斜杠会被忽略掉</td>
</tr>
<tr>
  <td>:se inde=len(' abc')</td>
  <td>无</td>
  <td>无</td>
  <td>空格未被转义，不合法表达式</td>
</tr>
<tr>
  <td>:se inde=len('ab"c')</td>
  <td>"len('ab"c')"</td>
  <td>len('ab</td>
  <td>双引号"未被转义，所中间的"后的字串被省略</td>
</tr>
<tr>
  <td>:se inde=len(\"&#92;t\")</td>
  <td>"len(\"&#92;t\")"</td>
  <td>len("\t")</td>
  <td></td>
</tr>
</tbody>
</table>

<p>正因为在计算len()之前已经先计算了字串值一次，所以本来，</p>

<pre><code>func! GetIndent(lnum)
    return len(split(substitute(getline(v:lnum),'^[ \t]*\([0-9.]\+\).*','\1',''),'\.'))*&amp;sw
endfunc
se inde=GetIndent(v:lnum)
</code></pre>

<p>不用转义的表达式，直接放到<code>:se inde</code>命令后，就成了：</p>

<pre><code>:se inde=len(split(substitute(getline(v:lnum),'^[\ \\t]*\\([0-9.]\\+\\).*','\\1',''),'\\.'))*&amp;sw
</code></pre>

<p>可以看到多了一堆的反斜杠（'\'）。不与这些转义规则打交道的方法是尽量将它们包装在独立的函数中（这样不用使用沙箱）。如果一定要用的话尽量少用空格与双引号。</p>

<div class="footnotes">
<hr />
<ol>

<li id="fn:1">
<p>事实上几乎所有的嵌套结构都是这样的&#160;<a href="#fnref:1" rev="footnote" class="footnote-backref">&#8617;</a></p>
</li>

<li id="fn:2">
<p>但有个'-'号会比空行直观一点。&#160;<a href="#fnref:2" rev="footnote" class="footnote-backref">&#8617;</a></p>
</li>

</ol>
</div>

                        </article>
                        <hr class="soften">
                                                <ul class="pager">
                            <li class="previous"><a href="http://b.soont.com/vim/tut_tags" title="Tags-Vim进阶[7]">上一篇</a></li>
                            <li class="next"><a href="http://b.soont.com/word/" title="MS Word笔记">下一篇</a></li>
                        </ul>
                                                        
                        </div>

                        <div class="col-md-3">
                            <!--
                            <div id="googlesearch">
                                <script>
                                  (function() {
                                    var cx = '015053503464820548847:d8u_zcpmbhq';
                                    var gcse = document.createElement('script');
                                    gcse.type = 'text/javascript';
                                    gcse.async = true;
                                    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                                        '//www.google.com/cse/cse.js?cx=' + cx;
                                    var s = document.getElementsByTagName('script')[0];
                                    s.parentNode.insertBefore(gcse, s);
                                  })();
                                </script>
                                <gcse:search></gcse:search>
                                </div>
                                -->
                            <div class="nav-group">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <ul class="nav nav-pills nav-stacked" id="navv">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <li><a data-toggle="collapse" data-parent="#navv" href="#category1" class="collapsed"><span id="folder1" class="glyphicon glyphicon-folder-close"></span> LINUX<span class="badge pull-right">8</span></a></li>
                                    <li>
                                    <ul id="category1"  class="nav nav-pills nav-stacked collapse">
                                                                                                                                                                                                        <li><a href="http://b.soont.com/linux/linux-tar"><small>Linux下归档与压缩<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/linux/tmux"><small>tmux终端复用<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/linux/vim-tabnew"><small>Ubuntu下Gvim自动在新标签页打开文件<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/linux/date"><small>date日期命令<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/linux/shell-shortcuts"><small>Shell快捷键<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/linux/shell-tips"><small>Shell小技巧<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/linux/git"><small>GIT笔记<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/linux/rsync"><small>rsync同步命令<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </ul>
                                    </li>
                        <script type="text/javascript">
                            $('#category1').on('show.bs.collapse', function () {
                                $("#folder1").attr("class","glyphicon glyphicon-folder-open");});
                            $('#category1').on('hidden.bs.collapse', function () {
                                $("#folder1").attr("class","glyphicon glyphicon-folder-close");
});</script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <li><a data-toggle="collapse" data-parent="#navv" href="#category2" class="collapsed"><span id="folder2" class="glyphicon glyphicon-folder-open"></span> VIM<span class="badge pull-right">15</span></a></li>
                                    <li>
                                    <ul id="category2"  class="nav nav-pills nav-stacked collapse in">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <li><a href="http://b.soont.com/vim/vim-tips"><small>VIM小技巧<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/zencoding"><small>ZenCoding(emmet)前端利器<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <li class="active"><a href="http://b.soont.com/vim/tut_indent"><small><em>缩进-Vim进阶[8] <span class="glyphicon glyphicon-eye-open"></span></em></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/tut_tags"><small>Tags-Vim进阶[7]<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/tut_bang"><small>外部程序-Vim进阶[6]<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/tut_hl"><small>高亮-Vim进阶[5]<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/tut_register"><small>寄存器-Vim进阶[4]<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/tut_script"><small>脚本-Vim进阶[3]<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/tut_folding"><small>折叠-Vim进阶[2]<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/tut_modeline"><small>模式行-Vim进阶[1]<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/part4"><small>第四章 替换命令<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/part3"><small>第三章 功能强大的全局命令<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/part2"><small>第二章 行模式地址<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/part1"><small>第一章 Vi基础<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/vim/vundle"><small>Vundle插件管理<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </ul>
                                    </li>
                        <script type="text/javascript">
                            $('#category2').on('show.bs.collapse', function () {
                                $("#folder2").attr("class","glyphicon glyphicon-folder-open");});
                            $('#category2').on('hidden.bs.collapse', function () {
                                $("#folder2").attr("class","glyphicon glyphicon-folder-close");
});</script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <li><a data-toggle="collapse" data-parent="#navv" href="#category3" class="collapsed"><span id="folder3" class="glyphicon glyphicon-folder-close"></span> 计算机<span class="badge pull-right">3</span></a></li>
                                    <li>
                                    <ul id="category3"  class="nav nav-pills nav-stacked collapse">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <li><a href="http://b.soont.com/md/php-markdown"><small>PHP Markdown Extra 中文使用说明<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/classic/smart-questions-zh"><small>提问的智慧<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <li><a href="http://b.soont.com/md/syntax_cn"><small>Markdown 语法<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </ul>
                                    </li>
                        <script type="text/javascript">
                            $('#category3').on('show.bs.collapse', function () {
                                $("#folder3").attr("class","glyphicon glyphicon-folder-open");});
                            $('#category3').on('hidden.bs.collapse', function () {
                                $("#folder3").attr("class","glyphicon glyphicon-folder-close");
});</script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <li><a data-toggle="collapse" data-parent="#navv" href="#category4" class="collapsed"><span id="folder4" class="glyphicon glyphicon-folder-close"></span> RUBY<span class="badge pull-right">1</span></a></li>
                                    <li>
                                    <ul id="category4"  class="nav nav-pills nav-stacked collapse">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <li><a href="http://b.soont.com/ruby/requre-load-include"><small>requre load include 区别<span class="glyphicon glyphicon-file"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </ul>
                                    </li>
                        <script type="text/javascript">
                            $('#category4').on('show.bs.collapse', function () {
                                $("#folder4").attr("class","glyphicon glyphicon-folder-open");});
                            $('#category4').on('hidden.bs.collapse', function () {
                                $("#folder4").attr("class","glyphicon glyphicon-folder-close");
});</script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <li><a data-parent="#navv" data-toggle="collapse" href="#nocategory" class="collapsed"><span class="glyphicon glyphicon-tags"></span> 未分类<span class="badge pull-right">1</span></a></li>
                                <li>
                                <ul id="nocategory" class="nav nav-pills nav-stacked collapse">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <li><a href="http://b.soont.com/diary/2013.11.04"><small>V <span class="glyphicon glyphicon-tag"></span></small></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </ul>
                                </li>
                            </ul>
                            </div>
                        </div>


                    </div>
                </div><!--container-->

                <footer role="contentinfo" class="bs-footer">
                <hr>
                <div class="container">
                    <p class="text-center"><a href="http://www.vim.org" title="用VIM进行创作"><img alt="用VIM进行创作" src="http://dn-bsoont.qbox.me/themes/soon/vim_powered.png" /></a></p>
                    <p class="text-center"><small>作品采用</small><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh"><img alt="知识共享许可" src="http://dn-bsoont.qbox.me/themes/soon/cc.png" /></a><small>进行许可</small></p>
                    <p class="text-center"> <small>&copy; 2012 - 2013 Designed by <a href="http://www.soont.com">Maucat <span class="glyphicon glyphicon-leaf"></span></a></small></p>
                </div>
                </footer>

        <script src="http://cdn.staticfile.org/jquery-scrollUp/2.1.0/jquery.scrollUp.min.js"></script>
        <script src="http://cdn.staticfile.org/mathjax/2.2/MathJax.js"></script>
        <script src="http://cdn.staticfile.org/mathjax/2.2/config/TeX-AMS_HTML.js"></script>
        <script src="http://dn-bsoont.qbox.me/themes/soon/js/bootstrap-paginator.min.js"></script>
<script>
        // 动态效果完成后更改心心与下拉的箭头，以及点击后给li加上active的class
            $(document).ready(function(){
                $("#desc1").hide();
                $("#xinxin1").attr("class","glyphicon glyphicon-heart pull-right");
                $("#jiantou1").attr("class","glyphicon glyphicon-chevron-up");
                $(".nav-group li").click(function(){
                    $(".nav-group li").removeClass("active");
                    $(this).addClass("active");
                    });
                //为文章内的表格添加table class
                $("article>table").addClass("table");
                //给不是内部链接的链接加上target属性，_blank值
                $("a[href*='http://']:not([href*='"+location.hostname+"']),[href*='https://']:not([href*='"+location.hostname+"'])").attr("target","_blank");
                //锚点偏移

                $("article a, .panel-body a").click(function() {
                        $("html, body").animate({
                            scrollTop: $($(this).attr("href")).offset().top - 70 + "px"
                        }, 0);
                        return false;
                    });
                });


                // 分页插件                     
var options = {
    currentPage: 1,
    totalPages: 6,
    bootstrapMajorVersion: 1,
    pageUrl: function(type, page, current){

        return "http://b.soont.com/page/"+page;

    },
tooltipTitles: function (type, page, current) {
                    switch (type) {
                    case "first":
                        return "第一页";
                    case "prev":
                        return "上一页";
                    case "next":
                        return "下一页";
                    case "last":
                        return "最后一页";
                    case "page":
                        return null;
                    }
                }
    }
    $('#pagin').bootstrapPaginator(options);

//滚动到页顶设置
		$(function () {
			$.scrollUp({
		        scrollName: 'scrollUp', // Element ID
		        scrollDistance: 300, // Distance from top/bottom before showing element (px)
		        scrollFrom: 'top', // 'top' or 'bottom'
		        scrollSpeed: 1300, // Speed back to top (ms)
		        easingType: 'linear', // Scroll to top easing (see http://easings.net/)
		        animation: 'slide', // Fade, slide, none
		        animationInSpeed: 500, // Animation in speed (ms)
		        animationOutSpeed: 500, // Animation out speed (ms)
		        scrollText: '回到页首', // Text for element, can contain HTML
		        scrollTitle: false, // Set a custom <a> title if required. Defaults to scrollText
		        scrollImg: false, // Set true to use image
		        zIndex: 10000 // Z-Index for the overlay
			});
		});
</script>
            </body>
        </html>
